// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tabla de Usuarios
model User {
  id        Int     @id @default(autoincrement())
  username  String  @unique
  email     String  @unique
  passwordHash String @map("password_hash")
  fullName  String? @map("full_name")
  role      String  @default("user")
  isActive  Boolean @default(true) @map("is_active")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relaciones
  inventoryMovements InventoryMovement[]
  auditLogs AuditLog[]
  purchaseOrders PurchaseOrder[]

  @@map("users")
}

// Tabla de Categorías
model Category {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  description String?
  isActive  Boolean @default(true) @map("is_active")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relaciones
  products Product[]

  @@map("categories")
}

// Tabla de Productos
model Product {
  id              Int     @id @default(autoincrement())
  name            String
  sku             String  @unique
  description     String?
  price           Decimal @db.Decimal(10, 2)
  cost            Decimal? @db.Decimal(10, 2)
  categoryId      Int     @map("category_id")
  quantityInStock Int     @default(0) @map("quantity_in_stock")
  reorderLevel    Int     @default(10) @map("reorder_level")
  status          String  @default("active")
  supplier        String?
  barcode         String?
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relaciones
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  inventoryMovements InventoryMovement[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([categoryId])
  @@index([sku])
  @@index([status])
  @@map("products")
}

// Tabla de Movimientos de Inventario
model InventoryMovement {
  id            Int     @id @default(autoincrement())
  productId     Int     @map("product_id")
  movementType  String  @map("movement_type")
  quantity      Int
  referenceType String? @map("reference_type")
  referenceId   String? @map("reference_id")
  notes         String?
  createdById   Int?    @map("created_by")
  
  createdAt DateTime @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relaciones
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([movementType])
  @@index([createdAt])
  @@map("inventory_movements")
}

// Tabla de Órdenes de Compra
model PurchaseOrder {
  id                  Int     @id @default(autoincrement())
  orderNumber         String  @unique @map("order_number")
  supplierId          Int?    @map("supplier_id")
  status              String  @default("pending")
  expectedDeliveryDate DateTime? @map("expected_delivery_date")
  receivedDate        DateTime? @map("received_date")
  totalAmount         Decimal? @db.Decimal(12, 2) @map("total_amount")
  notes               String?
  createdById         Int?    @map("created_by")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  // Relaciones
  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)
  items PurchaseOrderItem[]

  @@map("purchase_orders")
}

// Tabla de Detalles de Órdenes de Compra
model PurchaseOrderItem {
  id                Int     @id @default(autoincrement())
  purchaseOrderId   Int     @map("purchase_order_id")
  productId         Int     @map("product_id")
  quantityOrdered   Int     @map("quantity_ordered")
  quantityReceived  Int     @default(0) @map("quantity_received")
  unitPrice         Decimal @db.Decimal(10, 2) @map("unit_price")
  receivedAt        DateTime? @map("received_at")
  
  // Relaciones
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

// Tabla de Auditoría
model AuditLog {
  id          Int     @id @default(autoincrement())
  userId      Int?    @map("user_id")
  action      String
  entityType  String  @map("entity_type")
  entityId    Int?    @map("entity_id")
  oldValues   Json?   @map("old_values")
  newValues   Json?   @map("new_values")
  ipAddress   String? @map("ip_address")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relaciones
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
